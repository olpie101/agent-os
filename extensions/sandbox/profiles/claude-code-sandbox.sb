;; Claude Code Sandbox Security Profile
;; Version: 1.2.0 - Task 7: Executable permissions configuration
;; This profile restricts Claude Code to specific development directories

(version 1)

;; Default deny all permissions
(deny default)
(import "dyld-support.sb")

(allow process-fork)
;; process-exec is restricted to specific paths defined later
(allow signal (target self))
(allow system-sched (target self))

;; Basic system operations needed for execution
(allow iokit-open)
(allow iokit-get-properties)  ;; Task 8: Network interface enumeration
(allow mach* sysctl-read)
(allow file-ioctl)
(allow file-read-metadata)
(allow process-info*)  ;; Task 8: System state queries for curl

;; ====================================
;; PARAMETERS (will be set by launcher)
;; ====================================
;; DEV_WORKSPACE   - Development workspace directory
;; WORKING_DIR     - Current working directory
;; AGENT_OS_DIR    - Agent OS directory
;; HOME            - User's home directory
;; NATS_URL        - NATS server URL
;; NATS_CREDS      - NATS credentials file path
;; AUDIT_LOG_PATH  - Audit log directory
;; VERBOSE_MODE    - Enable verbose logging
;; EXTRA_EXEC_PATH - Additional executable path

;; ====================================
;; EXPLICIT DENY RULES - SENSITIVE DIRECTORIES
;; Task 6: These deny rules MUST come before allow rules
;; ====================================

;; Task 6.2: Deny .ssh directory access
;; (deny file-read* file-write*
;;     (subpath (string-append (param "HOME") "/.ssh")))

;; Task 6.3: Deny cloud credentials access
(deny file-read* file-write*
    (subpath (string-append (param "HOME") "/.aws"))
    (subpath (string-append (param "HOME") "/.gcp"))
    (subpath (string-append (param "HOME") "/.azure"))
    (subpath (string-append (param "HOME") "/.config/gcloud"))
    (subpath (string-append (param "HOME") "/.config/azure")))

;; Task 6.4: Deny git credentials and shell history
;; Note: .gitconfig removed from deny list - now allowed for git operations (security trade-off)
;; Note: .bash_history removed from deny list - user doesn't use bash
(deny file-read* file-write*
    ;; .gitconfig removed - see read permissions section
    (literal (string-append (param "HOME") "/.git-credentials"))  ;; Still deny direct credential storage
    ;; .bash_history removed - user doesn't use bash
    (literal (string-append (param "HOME") "/.zsh_history"))
    (literal (string-append (param "HOME") "/.zhistory"))
    (literal (string-append (param "HOME") "/.sh_history")))

;; Task 6.5: Deny .kube and .android directories
(deny file-read* file-write*
    (subpath (string-append (param "HOME") "/.kube"))
    (subpath (string-append (param "HOME") "/.android")))

;; Task 6.6: Deny browser profiles and password stores
(deny file-read* file-write*
    ;; Browser profiles
    (subpath (string-append (param "HOME") "/Library/Application Support/Google/Chrome"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Firefox"))
    (subpath (string-append (param "HOME") "/Library/Safari"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Microsoft Edge"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Arc"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Brave Software"))
    
    ;; Password stores and security data
    (subpath (string-append (param "HOME") "/.gnupg"))
    (subpath (string-append (param "HOME") "/.password-store"))
    (subpath (string-append (param "HOME") "/Library/Group Containers/2BUA8C4S2C.com.1password"))
    (subpath (string-append (param "HOME") "/Library/Group Containers/com.dashlane"))
    (subpath (string-append (param "HOME") "/Library/Application Support/Bitwarden"))
    
    ;; Other sensitive directories
    ;; (subpath (string-append (param "HOME") "/.netrc"))
    (subpath (string-append (param "HOME") "/.docker"))
    (subpath (string-append (param "HOME") "/.npmrc"))  ;; May contain auth tokens
    (subpath (string-append (param "HOME") "/.yarnrc"))  ;; May contain auth tokens
    (subpath (string-append (param "HOME") "/.gradle"))  ;; May contain credentials
    (subpath (string-append (param "HOME") "/.m2"))      ;; Maven settings with credentials
    (subpath (string-append (param "HOME") "/.vault-token"))
    (subpath (string-append (param "HOME") "/.terraform.d")))

;; ====================================
;; FILE SYSTEM - READ PERMISSIONS
;; ====================================
;; Keychain access for password retrieval
(allow file-read*
    ;; System keychains
    (subpath "/Library/Keychains")
    (subpath "/System/Library/Keychains")
    
    ;; User keychains  
    (literal (string-append (param "HOME") "/Library/Keychains/login.keychain"))
    (literal (string-append (param "HOME") "/Library/Keychains/login.keychain-db"))
    (subpath (string-append (param "HOME") "/Library/Keychains")))

(allow file-read*
    ;; Development workspace (Task 3.2: replaced HOME with DEV_WORKSPACE)
    (subpath (param "DEV_WORKSPACE"))
    (subpath (param "WORKING_DIR"))
    (subpath (string-append (param "HOME") "/.netrc"))
    (literal "/usr/bin/env")
    (subpath "/proc")
    (literal "/dev/urandom")

    ;; (subpath (string-append (param "HOME") "/.ssh"))
    
    ;; Task 4.3: System directories needed for execution (explicit allow list)
    (subpath "/usr")
    (subpath "/bin")
    (subpath "/sbin")
    (subpath "/System")
    (subpath "/Library/Frameworks")
    
    ;; Task 4.4: Homebrew paths
    (subpath "/opt/homebrew")  ;; Homebrew on Apple Silicon
    (subpath "/usr/local")     ;; Homebrew on Intel
    (literal "/bin/ps")
    
    ;; Nix store for Nix package manager
    (subpath "/nix/store")
    
    ;; Xcode developer tools (for clang/compiler access)
    (subpath "/Applications/Xcode.app/Contents/Developer")
    (subpath "/Applications/Xcode.app/Contents/SystemLibraries")
    (subpath "/Applications/Xcode.app/Contents/SystemFrameworks")
    (literal "/Applications/Xcode.app/Contents/SharedFrameworks/DVTSystemPrerequisites.framework/Versions/A/DVTSystemPrerequisites")
    
    ;; Network configuration and SSL/TLS certificates (Task 8)
    (subpath "/etc/ssl")         ;; SSL configuration and certificates
    (subpath "/private/etc/ssl") ;; macOS actual path for SSL config
    (literal "/etc/hosts")       ;; Hostname resolution
    (literal "/private/etc/hosts")
    (literal "/etc/resolv.conf") ;; DNS configuration
    (literal "/private/etc/resolv.conf")
    
    ;; DNS and network support files (Task 8)
    (subpath "/var/run")         ;; Unix domain sockets for DNS
    (literal "/var/run/mDNSResponder")
    (literal "/etc/services")    ;; Service name mappings
    (literal "/private/etc/services")
    (literal "/etc/protocols")   ;; Protocol definitions
    (literal "/private/etc/protocols")
    
    ;; System configuration preferences for network (Task 8)
    (subpath "/System/Library/Preferences/SystemConfiguration")
    
    ;; Task 8.6 Fix: Additional files needed for curl DNS resolution
    (literal (string-append (param "HOME") "/.CFUserTextEncoding"))  ;; User text encoding
    (literal "/Library/Preferences/com.apple.networkd.plist")        ;; Network daemon prefs
    (literal "/private/Library/Preferences/com.apple.networkd.plist") ;; Alternate path
    (literal "/dev/dtracehelper")                                     ;; System tracer (read)
    (literal "/dev/autofs_nowait")                                    ;; Automount support
    
    ;; Temporary directories
    (subpath "/tmp")
    (subpath "/var/tmp")
    (subpath "/private/tmp")
    (subpath "/private/var")
    
    ;; Podman socket access in temporary directories
    (regex "^/var/folders/.*/T/podman/.*\\.sock$")
    (subpath "/var/folders")
    
    ;; Task 3.3: Agent OS configuration directory
    (subpath (param "AGENT_OS_DIR"))
    
    ;; Task 4.5 & 4.6: Restrict HOME access to specific subdirectories
    ;; Language version managers (read-only access)
    (subpath (string-append (param "HOME") "/.nvm"))      ;; Node Version Manager
    (subpath (string-append (param "HOME") "/.rbenv"))    ;; Ruby version manager
    (subpath (string-append (param "HOME") "/.pyenv"))    ;; Python version manager
    (subpath (string-append (param "HOME") "/.cargo"))    ;; Rust/Cargo
    (subpath (string-append (param "HOME") "/.rustup"))   ;; Rust toolchain
    (subpath (string-append (param "HOME") "/.bun"))      ;; Bun runtime
    (subpath (string-append (param "HOME") "/.kcl"))
    (subpath (string-append (param "HOME") "/.config/gh"))
    (subpath (string-append (param "HOME") "/.config/containers"))
    (subpath (string-append (param "HOME") "/.config/ccaos"))
    (subpath (string-append (param "HOME") "/.context"))
    
    ;; Package manager caches (read-only)
    (subpath (string-append (param "HOME") "/.npm"))      ;; NPM cache
    (subpath (string-append (param "HOME") "/.gem"))      ;; Ruby gems
    (subpath (string-append (param "HOME") "/.cache"))    ;; General cache
    (subpath (string-append (param "HOME") "/.bundle"))   ;; Bundler cache
    (subpath (string-append (param "HOME") "/go"))        ;; Go
    (subpath (string-append (param "HOME") "/Library/Application Support/go"))
    
    ;; Claude configuration
    (subpath (string-append (param "HOME") "/.claude"))  ;; Claude config directory
    (subpath (string-append (param "HOME") "/Library/Caches"))
    (literal (string-append (param "HOME") "/.claude.json")) 
    (literal (string-append (param "HOME") "/.claude.json.backup")) 
    (literal (string-append (param "HOME") "/.claude.json.lock")) 
    (regex (string-append "^" (regex-quote (param "HOME")) "/\\.claude\\.json\\.tmp\\..*"))
    (literal (string-append (param "HOME") "/.docker/config.json")) 
    
    ;; /dev/null needs read access for git operations
    (literal "/dev/null")
    
    ;; TTY and device access for shell operations
    (literal "/dev/tty")
    (regex "^/dev/ttys[0-9]+$")
    (regex (string-append "^" (regex-quote (param "HOME")) "/\\.claude\\.json\\.tmp\\..*"))
    (literal "/dev")
    
    ;; Git configuration files (security trade-off: may contain credentials)
    (literal (string-append (param "HOME") "/.gitconfig"))        ;; Global git config
    (literal (string-append (param "HOME") "/.gitignore_global")) ;; Global ignore patterns
    (literal (string-append (param "HOME") "/.stCommitMsg"))      ;; SourceTree commit template
    
    ;; Shell configuration files (read-only for shell initialization)
    (literal (string-append (param "HOME") "/.bashrc"))
    (literal (string-append (param "HOME") "/.ssh/known_hosts"))
    (literal (string-append (param "HOME") "/.zshrc"))
    (literal (string-append (param "HOME") "/.npmrc"))
    (literal (string-append (param "HOME") "/.bash_profile"))
    (literal (string-append (param "HOME") "/.zprofile"))
    (literal (string-append (param "HOME") "/.bash_history"))  ;; Bash history (user doesn't use bash)
    (literal (string-append (param "HOME") "/.fzf.bash"))      ;; FZF bash configuration
    (literal (string-append (param "HOME") "/.fzf.zsh"))      ;; FZF zsh configuration
    (subpath (string-append (param "HOME") "/go/bin"))
    (subpath (string-append (param "HOME") "/.local/bin"))
    (subpath (string-append (param "HOME") "/.local/share/containers"))
    (subpath (string-append (param "HOME") "/.local/share/nats/nsc/keys/creds/sava_technologies/DEV_EDUARDO"))
    (subpath (string-append (param "HOME") "/.krew/bin"))
    (subpath (string-append (param "HOME") "/Library/Android/sdk/emulator"))
    (subpath (string-append (param "HOME") "/Library/Android/sdk/platform-tools"))
    (subpath (string-append (param "HOME") "/.dotnet/tools"))
    (subpath (string-append (param "HOME") "/.zsh-cache"))
    (subpath (string-append (param "HOME") "/.zsh_plugins.zsh"))
    (subpath (string-append (param "HOME") "/.zcompdump"))
    (subpath (string-append (param "HOME") "/dev/zen-mcp-server"))
    (subpath (string-append (param "HOME") "/.local/pipx"))
    (subpath (string-append (param "HOME") "/.dotfiles")))  ;; Dotfiles directory

;; ====================================
;; FILE SYSTEM - WRITE PERMISSIONS
;; ====================================
(allow file-write*
    ;; Current working directory
    (subpath (param "WORKING_DIR"))
    
    ;; Temporary directories
    (subpath "/tmp")
    (subpath "/var/tmp")
    (subpath "/private/var/run/user")
    (subpath "/private/var/folders")
    (subpath "/private/tmp")
    (subpath "/private/var/tmp")
    
    ;; Podman socket write access
    (regex "^/var/folders/.*/T/podman/.*\\.sock$")
    (subpath "/var/folders")
    
    ;; Standard I/O
    (literal "/dev/stdout")
    (literal "/dev/stderr")
    (literal "/dev/stdin")
    (literal "/dev/null")      ;; Also in read section for git operations
    (literal "/dev/urandom")
    (literal "/dev/random")
    (literal "/dev/tty")
    (regex "^/dev/ttys[0-9]+$")
    
    ;; Task 8.6 Fix: dtracehelper requires write permission for curl
    (literal "/dev/dtracehelper")
    
    ;; Task 3.5: Package manager caches (write access for updates)
    (subpath (string-append (param "HOME") "/.npm"))          ;; NPM cache
    (subpath (string-append (param "HOME") "/.nvm"))          ;; NPM cache
    (subpath (string-append (param "HOME") "/.cache"))        ;; General cache
    (subpath (string-append (param "HOME") "/.bundle"))       ;; Bundler cache
    (subpath (string-append (param "HOME") "/.cargo/registry")) ;; Cargo registry
    (subpath (string-append (param "HOME") "/.gem"))          ;; Ruby gems
    (subpath (string-append (param "HOME") "/Library/Caches/go-build"))
    (subpath (string-append (param "HOME") "/Library/Application Support/go"))
    (subpath (string-append (param "HOME") "/go/pkg/mod/cache"))          ;; Go Cache
    
    ;; Audit log location (project-specific)
    (subpath (param "AUDIT_LOG_PATH"))

    

    (subpath (string-append (param "HOME") "/.claude"))  ;; Claude config directory
    (subpath (string-append (param "HOME") "/Library/Caches/claude-cli-nodejs"))
    (literal (string-append (param "HOME") "/.claude.json")) 
    (literal (string-append (param "HOME") "/.claude.json.backup")) 
    (literal (string-append (param "HOME") "/.claude.json.lock"))
    (regex (string-append "^" (regex-quote (param "HOME")) "/\\.claude\\.json\\.tmp\\..*"))
    (subpath (string-append (param "HOME") "/.kcl"))
    (subpath (string-append (param "HOME") "/.context"))

    (subpath (string-append (param "HOME") "/dev/zen-mcp-server"))

    (subpath (string-append (param "HOME") "/Library/Keychains"))

    (literal (string-append (param "HOME") "/.config/containers/podman/machine/applehv/podman-machine-default.lock"))
    (subpath (string-append (param "HOME") "/.config/containers"))
    (subpath (string-append (param "HOME") "/.local/share/containers"))
    ;; Bash history write permission (user doesn't use bash)
    (literal (string-append (param "HOME") "/.bash_history")))

(allow file-write-mode (subpath "/opt/homebrew/share/zsh"))

;; ====================================
;; PROCESS EXECUTION
;; ====================================
(allow process-exec*
    ;; Core system commands
    (literal "/bin/sh")
    (literal "/bin/bash")
    (literal "/bin/zsh")
    (literal "/opt/homebrew/bin/bash")  ;; Homebrew bash
    (literal "/bin/cat")
    (literal "/bin/date")
    (literal "/bin/echo")
    (literal "/bin/pwd")
    (literal "/bin/mkdir")
    (literal "/bin/rm")
    (literal "/bin/cp")
    (literal "/bin/mv")
    (literal "/bin/ls")
    (literal "/bin/chmod")
    (literal "/bin/test")
    (literal "/bin/ps")
    (literal "/usr/sbin/ioreg")
    
    ;; Standard Unix tools
    (literal "/usr/bin/find")
    (literal "/usr/bin/make")
    (literal "/usr/bin/sed")
    (literal "/usr/bin/awk")
    (literal "/usr/bin/grep")
    (literal "/usr/bin/python3")  ;; Python for podman-compose
    (literal "/usr/bin/mktemp")
    (literal "/usr/bin/wc")
    (literal "/usr/bin/dirname")
    (literal "/usr/bin/basename")
    (literal "/usr/bin/head")
    (literal "/usr/bin/tail")
    (literal "/usr/bin/sort")
    (literal "/usr/bin/uniq")
    (literal "/usr/bin/cut")
    (literal "/usr/bin/which")
    (literal "/usr/bin/env")
    (literal "/usr/bin/afplay")  ;; macOS sound player
    (literal "/usr/bin/sw_vers")
    (literal "/usr/bin/tput")
    (literal "/usr/bin/open")
    (literal "/usr/bin/ssh-agent")
    (literal "/usr/bin/security")
    (literal "/usr/bin/codesign")
    
    ;; Network testing tools
    (literal "/usr/bin/curl")     ;; HTTP/HTTPS client
    (literal "/usr/bin/nc")       ;; Netcat for port testing
    (literal "/usr/bin/wget")     ;; Alternative HTTP client
    (literal "/usr/bin/telnet")   ;; Legacy network testing
    (literal "/usr/bin/dig")      ;; DNS lookup tool
    (subpath "/Applications/Xcode.app/Contents/Developer/usr/bin")
    
    ;; NVM installation requirements (TEMPORARY - disable after nvm setup)
    (literal "/usr/bin/tar")       ;; Archive extraction for node downloads
    (literal "/usr/sbin/sysctl")   ;; System info for core count detection
    (literal "/usr/bin/clang")     ;; C compiler for building from source
    (literal "/usr/bin/getconf")   ;; System configuration values
    (literal "/usr/bin/bsdtar")    ;; BSD tar for archive extraction
    
    ;; Development tools via Homebrew
    (subpath "/opt/homebrew/bin")
    (subpath "/opt/homebrew/opt")
    (subpath "/opt/homebrew/Cellar")  ;; Actual binary locations
    (subpath "/opt/homebrew/lib")      ;; Dynamic libraries
    (subpath "/usr/local/bin")
    (subpath "/usr/local/share")
    (subpath "/usr/local/opt")         ;; Intel Mac Homebrew
    
    ;; GNU coreutils from Homebrew
    (subpath "/opt/homebrew/opt/coreutils/libexec/gnubin")
    
    ;; Task 7.5: Development workspace executables
    (subpath (param "DEV_WORKSPACE"))
    (subpath (param "WORKING_DIR"))
    
    ;; Task 7.6: Agent OS scripts execution
    (subpath (string-append (param "HOME") "/.agent-os/scripts"))
    (literal (string-append (param "HOME") "/.claude/statusline-command.sh"))
    (subpath (string-append (param "HOME") "/.nvm"))
    (subpath (string-append (param "HOME") "/.npm/_npx"))
    (subpath (string-append (param "HOME") "/.local/bin"))
    (subpath (string-append (param "HOME") "/.local/pipx"))
    
    ;; Podman-compose via pipx
    (subpath (string-append (param "HOME") "/.local/pipx/venvs"))

    (subpath "/nix/store")

    
    ;; Go binaries in user's home directory
    (subpath (string-append (param "HOME") "/go/bin"))
    (regex #"^/var/folders/[^/]+/[^/]+/T/go-build[0-9]+/b[0-9]+/.*\.test$")
    (regex #"^/private/var/folders/[^/]+/[^/]+/T/go-build[0-9]+/b[0-9]+/.*\.test$")
    
    ;; Temporary directory executables (for testing)
    (subpath "/tmp")
    (subpath "/private/tmp"))

;; ====================================
;; NETWORK ACCESS
;; ====================================
(allow network-outbound)

;; Allow binding to local addresses for DNS and local servers (Task 8)
(allow network-bind
    (local ip "*:*"))  ;; Allow binding to any local port for DNS queries and local servers

;; Allow receiving network responses (Task 8)
(allow network-inbound
    (local ip "*:*"))  ;; Allow receiving responses on any local port

;; Unix domain socket support for podman
(allow network-bind
    (local unix-socket))
(allow network-inbound
    (local unix-socket))
(allow network-outbound
    (local unix-socket))

;; ====================================
;; IPC AND MACH SERVICES
;; ====================================
(allow ipc-posix-shm)
(allow mach-lookup)  ;; General mach service lookup
(allow signal)

;; DNS resolution support (Task 8)
(allow mach-lookup
    (global-name "com.apple.mDNSResponder")
    (global-name "com.apple.security.agent.login")
    (global-name "com.apple.security.agent")
    (global-name "com.apple.dnssd.service")
    (global-name "com.apple.networkd")
    (global-name "com.apple.nehelper")
    (global-name "com.apple.symptom_diagnostics")
    ;; Basic system services
    (global-name "com.apple.system.logger")
    
    ;; DNS and network resolution services
    (global-name "com.apple.system.DirectoryService.libinfo_v1")
    (global-name "com.apple.system.DirectoryService.membership_v1")
    (global-name "com.apple.dnssd.service")
    (global-name "com.apple.SystemConfiguration.configd")
    (global-name "com.apple.SystemConfiguration.DNSConfiguration")
    (global-name "com.apple.SystemConfiguration.NetworkInformation")
    (global-name "com.apple.SystemConfiguration.PPPController")
    (global-name "com.apple.SystemConfiguration.SCNetworkReachability")

    (global-name "com.apple.securityd.xpc")
    (global-name "com.apple.security.authhost")
    
    ;; Security and keychain services (for SSL/TLS)
    (global-name "com.apple.SecurityServer")
    (global-name "com.apple.security.SecurityServer")
    (global-name "com.apple.ocspd")
    (global-name "com.apple.system.notification_center"))

;; ====================================
;; SYSTEM OPERATIONS
;; ====================================
(allow system-socket)
(allow system-fsctl)
(allow system-info)  ;; Required for network interface queries
(allow sysctl-read)

;; Task 8.6 Fix: User preferences for curl DNS resolution
(allow user-preference-read)

;; IPC operations needed for keychain
(allow ipc-posix-shm-read-data
    (ipc-posix-name-regex #"^/tmp/com\.apple\.csseed\.")
    (ipc-posix-name "com.apple.AppleDatabaseChanged"))

(allow ipc-posix-shm-write-data
    (ipc-posix-name-regex #"^/tmp/com\.apple\.csseed\.")
    (ipc-posix-name "com.apple.AppleDatabaseChanged"))

(allow authorization-right-obtain)
